name: Publish modelbox images
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'new image tag(e.g. v1.1.0)'
        required: true
        default: 'latest'

env:
  BUILD_TYPE: Release
  IMAGE_VERSION: ${{ github.event.inputs.version }}

jobs:
  compile_cuda112_ubuntu:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-tensorflow_2.6.0-cuda_11.2-ubuntu-x86_64
    outputs:
      CUDA_VER: ${{ steps.env.outputs.CUDA_VER }}
      CUDA_VERSION: ${{ steps.env.outputs.CUDA_VERSION }}
      CUDA_CUDART_VERSION: ${{ steps.env.outputs.CUDA_CUDART_VERSION }}
      NVIDIA_CUDA_VERSION: ${{ steps.env.outputs.NVIDIA_CUDA_VERSION }}
      NVIDIA_REQUIRE_CUDA: ${{ steps.env.outputs.NVIDIA_REQUIRE_CUDA }}
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    env:
        CUDA_VER: "11-2"
        CUDA_VERSION: "11.2"
        CUDA_CUDART_VERSION: "11.2.152-1"
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=CUDA_VER::$(echo '11-2')"
        echo "::set-output name=CUDA_VERSION::$(echo '11.2')"
        echo "::set-output name=CUDA_CUDART_VERSION::$(echo '11.2.152-1')"
        echo "::set-output name=NVIDIA_CUDA_VERSION::$(echo '11.2.2')"
        echo "::set-output name=NVIDIA_REQUIRE_CUDA::$(echo 'cuda>=11.2 brand=tesla,driver>=418,driver<419 brand=tesla,driver>=440,driver<441 brand=tesla,driver>=450,driver<451 brand=tesla,driver>=460,driver<461')"
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-tensorflow_2.6.0-cuda_11.2-ubuntu-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-tensorflow_2.6.0-cuda_11.2-ubuntu-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_cuda112_ubuntu
        path: ./artifact
          
  build_cuda112_ubuntu_develop_image:
    runs-on: ubuntu-18.04
    needs: compile_cuda112_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda112_ubuntu
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.develop.ubuntu
          build-args: |
            CUDA_VER=${{ needs.compile_cuda112_ubuntu.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda112_ubuntu.outputs.CUDA_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda112_ubuntu.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda112_ubuntu.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda112_ubuntu.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda112_ubuntu.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_cuda112_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_cuda112_ubuntu_runtime_image:
    runs-on: ubuntu-18.04
    needs: compile_cuda112_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda112_ubuntu
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.runtime.ubuntu
          build-args: |
            CUDA_VER=${{ needs.compile_cuda112_ubuntu.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda112_ubuntu.outputs.CUDA_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda112_ubuntu.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda112_ubuntu.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda112_ubuntu.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda112_ubuntu.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_cuda112_ubuntu.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_cuda112_ubuntu:
    runs-on: ubuntu-latest
    needs: [compile_cuda112_ubuntu,build_cuda112_ubuntu_develop_image]
    container:
      image: ${{ needs.compile_cuda112_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_cuda102_trt_ubuntu:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-tensorrt_7.1.3-cuda_10.2-ubuntu-x86_64
    outputs:
      CUDA_VER: ${{ steps.env.outputs.CUDA_VER }}
      CUDA_VERSION: ${{ steps.env.outputs.CUDA_VERSION }}
      CUDA_CUDART_VERSION: ${{ steps.env.outputs.CUDA_CUDART_VERSION }}
      TRT_VERSION: ${{ steps.env.outputs.TRT_VERSION }}
      NVIDIA_CUDA_VERSION: ${{ steps.env.outputs.NVIDIA_CUDA_VERSION }}
      NVIDIA_REQUIRE_CUDA: ${{ steps.env.outputs.NVIDIA_REQUIRE_CUDA }}
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    env:
      CUDA_VER: "10-2"
      CUDA_VERSION: "10.2"
      CUDA_CUDART_VERSION: "10.2.89-1"
      TRT_VERSION: "7.1.3.4"
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=CUDA_VER::$(echo '10-2')"
        echo "::set-output name=CUDA_VERSION::$(echo '10.2')"
        echo "::set-output name=CUDA_CUDART_VERSION::$(echo '10.2.89-1')"
        echo "::set-output name=TRT_VERSION::$(echo '7.1.3.4')"
        echo "::set-output name=NVIDIA_CUDA_VERSION::$(echo '10.2.89')"
        echo "::set-output name=NVIDIA_REQUIRE_CUDA::$(echo 'cuda>=10.2 brand=tesla,driver>=396,driver<397 brand=tesla,driver>=410,driver<411 brand=tesla,driver>=418,driver<419 brand=tesla,driver>=440,driver<441')"
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-tensorrt_7.1.3-cuda_10.2-ubuntu-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-tensorrt_7.1.3-cuda_10.2-ubuntu-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_cuda102_trt_ubuntu
        path: ./artifact

  build_cuda102_trt_ubuntu_develop_image:
    runs-on: ubuntu-18.04
    needs: compile_cuda102_trt_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_trt_ubuntu
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.develop.ubuntu
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_trt_ubuntu.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.CUDA_VERSION }}
            TRT_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.TRT_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_trt_ubuntu.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_trt_ubuntu.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_cuda102_trt_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_cuda102_trt_ubuntu_runtime_image:
    runs-on: ubuntu-18.04
    needs: compile_cuda102_trt_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_trt_ubuntu
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.runtime.ubuntu
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_trt_ubuntu.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.CUDA_VERSION }}
            TRT_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.TRT_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_trt_ubuntu.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_trt_ubuntu.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_trt_ubuntu.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_cuda102_trt_ubuntu.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_cuda102_trt_ubuntu:
    runs-on: ubuntu-latest
    needs: [compile_cuda102_trt_ubuntu,build_cuda102_trt_ubuntu_develop_image]
    container:
      image: ${{ needs.compile_cuda102_trt_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_cuda102_torch_ubuntu:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-libtorch_1.9.1-cuda_10.2-ubuntu-x86_64
    outputs:
      CUDA_VER: ${{ steps.env.outputs.CUDA_VER }}
      CUDA_VERSION: ${{ steps.env.outputs.CUDA_VERSION }}
      CUDA_CUDART_VERSION: ${{ steps.env.outputs.CUDA_CUDART_VERSION }}
      TORCH_VERSION: ${{ steps.env.outputs.TORCH_VERSION }}
      NVIDIA_CUDA_VERSION: ${{ steps.env.outputs.NVIDIA_CUDA_VERSION }}
      NVIDIA_REQUIRE_CUDA: ${{ steps.env.outputs.NVIDIA_REQUIRE_CUDA }}
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    env:
      CUDA_VER: "10-2"
      CUDA_VERSION: "10.2"
      CUDA_CUDART_VERSION: "10.2.89-1"
      TORCH_VERSION: "1.9.1"
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=CUDA_VER::$(echo '10-2')"
        echo "::set-output name=CUDA_VERSION::$(echo '10.2')"
        echo "::set-output name=CUDA_CUDART_VERSION::$(echo '10.2.89-1')"
        echo "::set-output name=TORCH_VERSION::$(echo '1.9.1')"
        echo "::set-output name=NVIDIA_CUDA_VERSION::$(echo '10.2.89')"
        echo "::set-output name=NVIDIA_REQUIRE_CUDA::$(echo 'cuda>=10.2 brand=tesla,driver>=396,driver<397 brand=tesla,driver>=410,driver<411 brand=tesla,driver>=418,driver<419 brand=tesla,driver>=440,driver<441')"
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-libtorch_1.9.1-cuda_10.2-ubuntu-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-libtorch_1.9.1-cuda_10.2-ubuntu-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_cuda102_torch_ubuntu
        path: ./artifact

  build_cuda102_torch_ubuntu_develop_image:
    runs-on: ubuntu-18.04
    needs: compile_cuda102_torch_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_torch_ubuntu
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.develop.ubuntu
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_torch_ubuntu.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.CUDA_VERSION }}
            TORCH_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.TORCH_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_torch_ubuntu.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_torch_ubuntu.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_cuda102_torch_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_cuda102_torch_ubuntu_runtime_image:
    runs-on: ubuntu-18.04
    needs: compile_cuda102_torch_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_torch_ubuntu
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.runtime.ubuntu
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_torch_ubuntu.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.CUDA_VERSION }}
            TORCH_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.TORCH_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_torch_ubuntu.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_torch_ubuntu.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_torch_ubuntu.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_cuda102_torch_ubuntu.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_cuda102_torch_ubuntu:
    runs-on: ubuntu-latest
    needs: [compile_cuda102_torch_ubuntu,build_cuda102_torch_ubuntu_develop_image]
    container:
      image: ${{ needs.compile_cuda102_torch_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_ascend_ubuntu:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-mindspore_1.6.1-cann_5.0.4-ubuntu-x86_64
    outputs:
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-mindspore_1.6.1-cann_5.0.4-ubuntu-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-mindspore_1.6.1-cann_5.0.4-ubuntu-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_ascend_ubuntu
        path: ./artifact

  build_ascend_ubuntu_develop_image:
    runs-on: ubuntu-18.04
    needs: compile_ascend_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_ascend_ubuntu
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.ascend.develop.ubuntu
          tags: |
            ${{ needs.compile_ascend_ubuntu.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_ascend_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_ascend_ubuntu_runtime_image:
    runs-on: ubuntu-18.04
    needs: compile_ascend_ubuntu
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_ascend_ubuntu
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.ascend.runtime.ubuntu
          tags: |
            ${{ needs.compile_ascend_ubuntu.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_ascend_ubuntu.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_ascend_ubuntu:
    runs-on: ubuntu-latest
    needs: [compile_ascend_ubuntu,build_ascend_ubuntu_develop_image]
    container:
      image: ${{ needs.compile_ascend_ubuntu.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_cuda112_openeuler:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-tensorflow_2.6.0-cuda_11.2-openeuler-x86_64
    outputs:
      CUDA_VER: ${{ steps.env.outputs.CUDA_VER }}
      CUDA_VERSION: ${{ steps.env.outputs.CUDA_VERSION }}
      CUDA_CUDART_VERSION: ${{ steps.env.outputs.CUDA_CUDART_VERSION }}
      NVIDIA_CUDA_VERSION: ${{ steps.env.outputs.NVIDIA_CUDA_VERSION }}
      NVIDIA_REQUIRE_CUDA: ${{ steps.env.outputs.NVIDIA_REQUIRE_CUDA }}
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    env:
        CUDA_VER: "11-2"
        CUDA_VERSION: "11.2"
        CUDA_CUDART_VERSION: "11.2.152-1"
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=CUDA_VER::$(echo '11-2')"
        echo "::set-output name=CUDA_VERSION::$(echo '11.2')"
        echo "::set-output name=CUDA_CUDART_VERSION::$(echo '11.2.152-1')"
        echo "::set-output name=NVIDIA_CUDA_VERSION::$(echo '11.2.2')"
        echo "::set-output name=NVIDIA_REQUIRE_CUDA::$(echo 'cuda>=11.2 brand=tesla,driver>=418,driver<419 brand=tesla,driver>=440,driver<441 brand=tesla,driver>=450,driver<451 brand=tesla,driver>=460,driver<461')"
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-tensorflow_2.6.0-cuda_11.2-openeuler-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-tensorflow_2.6.0-cuda_11.2-openeuler-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_cuda112_openeuler
        path: ./artifact
          
  build_cuda112_openeuler_develop_image:
    runs-on: ubuntu-latest
    needs: compile_cuda112_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda112_openeuler
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.develop.openeuler
          build-args: |
            CUDA_VER=${{ needs.compile_cuda112_openeuler.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda112_openeuler.outputs.CUDA_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda112_openeuler.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda112_openeuler.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda112_openeuler.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda112_openeuler.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_cuda112_openeuler.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_cuda112_openeuler_runtime_image:
    runs-on: ubuntu-latest
    needs: compile_cuda112_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda112_openeuler
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.runtime.openeuler
          build-args: |
            CUDA_VER=${{ needs.compile_cuda112_openeuler.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda112_openeuler.outputs.CUDA_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda112_openeuler.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda112_openeuler.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda112_openeuler.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda112_openeuler.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_cuda112_openeuler.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_cuda112_openeuler:
    runs-on: ubuntu-latest
    needs: [compile_cuda112_openeuler,build_cuda112_openeuler_develop_image]
    container:
      image: ${{ needs.compile_cuda112_openeuler.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_cuda102_trt_openeuler:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-tensorrt_7.1.3-cuda_10.2-openeuler-x86_64
    outputs:
      CUDA_VER: ${{ steps.env.outputs.CUDA_VER }}
      CUDA_VERSION: ${{ steps.env.outputs.CUDA_VERSION }}
      CUDA_CUDART_VERSION: ${{ steps.env.outputs.CUDA_CUDART_VERSION }}
      TRT_VERSION: ${{ steps.env.outputs.TRT_VERSION }}
      NVIDIA_CUDA_VERSION: ${{ steps.env.outputs.NVIDIA_CUDA_VERSION }}
      NVIDIA_REQUIRE_CUDA: ${{ steps.env.outputs.NVIDIA_REQUIRE_CUDA }}
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    env:
      CUDA_VER: "10-2"
      CUDA_VERSION: "10.2"
      CUDA_CUDART_VERSION: "10.2.89-1"
      TRT_VERSION: "7.1.3.4"
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=CUDA_VER::$(echo '10-2')"
        echo "::set-output name=CUDA_VERSION::$(echo '10.2')"
        echo "::set-output name=CUDA_CUDART_VERSION::$(echo '10.2.89-1')"
        echo "::set-output name=TRT_VERSION::$(echo '7.1.3.4')"
        echo "::set-output name=NVIDIA_CUDA_VERSION::$(echo '10.2.89')"
        echo "::set-output name=NVIDIA_REQUIRE_CUDA::$(echo 'cuda>=10.2 brand=tesla,driver>=396,driver<397 brand=tesla,driver>=410,driver<411 brand=tesla,driver>=418,driver<419 brand=tesla,driver>=440,driver<441')"
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-tensorrt_7.1.3-cuda_10.2-openeuler-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-tensorrt_7.1.3-cuda_10.2-openeuler-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_cuda102_trt_openeuler
        path: ./artifact

  build_cuda102_trt_openeuler_develop_image:
    runs-on: ubuntu-latest
    needs: compile_cuda102_trt_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_trt_openeuler
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.develop.openeuler
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_trt_openeuler.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.CUDA_VERSION }}
            TRT_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.TRT_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_trt_openeuler.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_trt_openeuler.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_cuda102_trt_openeuler.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_cuda102_trt_openeuler_runtime_image:
    runs-on: ubuntu-latest
    needs: compile_cuda102_trt_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_trt_openeuler
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.runtime.openeuler
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_trt_openeuler.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.CUDA_VERSION }}
            TRT_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.TRT_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_trt_openeuler.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_trt_openeuler.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_trt_openeuler.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_cuda102_trt_openeuler.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_cuda102_trt_openeuler:
    runs-on: ubuntu-latest
    needs: [compile_cuda102_trt_openeuler,build_cuda102_trt_openeuler_develop_image]
    container:
      image: ${{ needs.compile_cuda102_trt_openeuler.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_cuda102_torch_openeuler:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-libtorch_1.9.1-cuda_10.2-openeuler-x86_64
    outputs:
      CUDA_VER: ${{ steps.env.outputs.CUDA_VER }}
      CUDA_VERSION: ${{ steps.env.outputs.CUDA_VERSION }}
      CUDA_CUDART_VERSION: ${{ steps.env.outputs.CUDA_CUDART_VERSION }}
      TORCH_VERSION: ${{ steps.env.outputs.TORCH_VERSION }}
      NVIDIA_CUDA_VERSION: ${{ steps.env.outputs.NVIDIA_CUDA_VERSION }}
      NVIDIA_REQUIRE_CUDA: ${{ steps.env.outputs.NVIDIA_REQUIRE_CUDA }}
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    env:
      CUDA_VER: "10-2"
      CUDA_VERSION: "10.2"
      CUDA_CUDART_VERSION: "10.2.89-1"
      TORCH_VERSION: "1.9.1"
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=CUDA_VER::$(echo '10-2')"
        echo "::set-output name=CUDA_VERSION::$(echo '10.2')"
        echo "::set-output name=CUDA_CUDART_VERSION::$(echo '10.2.89-1')"
        echo "::set-output name=TORCH_VERSION::$(echo '1.9.1')"
        echo "::set-output name=NVIDIA_CUDA_VERSION::$(echo '10.2.89')"
        echo "::set-output name=NVIDIA_REQUIRE_CUDA::$(echo 'cuda>=10.2 brand=tesla,driver>=396,driver<397 brand=tesla,driver>=410,driver<411 brand=tesla,driver>=418,driver<419 brand=tesla,driver>=440,driver<441')"
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-libtorch_1.9.1-cuda_10.2-openeuler-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-libtorch_1.9.1-cuda_10.2-openeuler-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_cuda102_torch_openeuler
        path: ./artifact

  build_cuda102_torch_openeuler_develop_image:
    runs-on: ubuntu-latest
    needs: compile_cuda102_torch_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_torch_openeuler
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.develop.openeuler
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_torch_openeuler.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.CUDA_VERSION }}
            TORCH_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.TORCH_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_torch_openeuler.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_torch_openeuler.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_cuda102_torch_openeuler.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_cuda102_torch_openeuler_runtime_image:
    runs-on: ubuntu-latest
    needs: compile_cuda102_torch_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_cuda102_torch_openeuler
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.cuda.runtime.openeuler
          build-args: |
            CUDA_VER=${{ needs.compile_cuda102_torch_openeuler.outputs.CUDA_VER }}
            CUDA_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.CUDA_VERSION }}
            TORCH_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.TORCH_VERSION }}
            CUDA_CUDART_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.CUDA_CUDART_VERSION }}
            NVIDIA_CUDA_VERSION=${{ needs.compile_cuda102_torch_openeuler.outputs.NVIDIA_CUDA_VERSION }}
            NVIDIA_REQUIRE_CUDA=${{ needs.compile_cuda102_torch_openeuler.outputs.NVIDIA_REQUIRE_CUDA }}
          tags: |
            ${{ needs.compile_cuda102_torch_openeuler.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_cuda102_torch_openeuler.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_cuda102_torch_openeuler:
    runs-on: ubuntu-latest
    needs: [compile_cuda102_torch_openeuler,build_cuda102_torch_openeuler_develop_image]
    container:
      image: ${{ needs.compile_cuda102_torch_openeuler.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest

  compile_ascend_openeuler:
    runs-on: ubuntu-latest
    container: modelbox/modelbox-develop-mindspore_1.6.1-cann_5.0.4-openeuler-x86_64
    outputs:
      IMAGE_NAME_DEV: ${{ steps.env.outputs.IMAGE_NAME_DEV }}
      IMAGE_NAME_RUN: ${{ steps.env.outputs.IMAGE_NAME_RUN }}
    steps:
    - name: Set-env
      id: env
      run: |
        echo "::set-output name=IMAGE_NAME_DEV::$(echo 'modelbox/modelbox-develop-mindspore_1.6.1-cann_5.0.4-openeuler-x86_64')"
        echo "::set-output name=IMAGE_NAME_RUN::$(echo 'modelbox/modelbox-runtime-mindspore_1.6.1-cann_5.0.4-openeuler-x86_64')"
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: ./build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Prepare Artifact
      run: |
        mkdir ./artifact
        cp -af ./build/release ./artifact/
        ls -lh ./artifact
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: modelbox_ascend_openeuler
        path: ./artifact

  build_ascend_openeuler_develop_image:
    runs-on: ubuntu-latest
    needs: compile_ascend_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_ascend_openeuler
          path: ./
      - name: Download for dev package
        run: ./docker/prepare_for_dev.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.ascend.develop.openeuler
          tags: |
            ${{ needs.compile_ascend_openeuler.outputs.IMAGE_NAME_DEV }}:latest
            ${{ needs.compile_ascend_openeuler.outputs.IMAGE_NAME_DEV }}:${{ env.IMAGE_VERSION }}

  build_ascend_openeuler_runtime_image:
    runs-on: ubuntu-latest
    needs: compile_ascend_openeuler
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: modelbox_ascend_openeuler
          path: ./
      - name: Download for run package
        run: ./docker/prepare_for_run.sh
        shell: bash
      - name: Build and Push
        uses: docker/build-push-action@v2
        with:
          push: true
          context: .
          file: ./docker/Dockerfile.ascend.runtime.openeuler
          tags: |
            ${{ needs.compile_ascend_openeuler.outputs.IMAGE_NAME_RUN }}:latest
            ${{ needs.compile_ascend_openeuler.outputs.IMAGE_NAME_RUN }}:${{ env.IMAGE_VERSION }}

  test_ascend_openeuler:
    runs-on: ubuntu-latest
    needs: [compile_ascend_openeuler,build_ascend_openeuler_develop_image]
    container:
      image: ${{ needs.compile_ascend_openeuler.outputs.IMAGE_NAME_DEV }}:${{ github.event.inputs.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: CMake
      run: |
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DWITH_ALL_DEMO=on
    - name: Build
      working-directory: build
      run: |
        make package -j8
    - name: Release check
      run: ./docker/artifact_check.sh
      shell: bash
    - name: Test
      working-directory: build
      run: | 
        make build-test -j8
        unset LD_LIBRARY_PATH
        make unittest
